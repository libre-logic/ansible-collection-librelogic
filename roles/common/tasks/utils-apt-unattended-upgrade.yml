---
- name: Run unattended-upgrades now
  ansible.builtin.command:
    cmd: /usr/bin/unattended-upgrade --verbose
  register: unattended_upgrade
  changed_when: '"No packages found that can be upgraded unattended and no pending auto-removals" not in unattended_upgrade.stdout'
  environment:
    LANG: C
    LC_ALL: C
    LANGUAGE: C

- name: List and display upgradable packages
  block:
    - name: List upgradable packages
      ansible.builtin.command:
        cmd: apt list --upgradable
      register: apt_upgradable
      changed_when: false
      check_mode: false # run even in check mode so that following tasks don't fail, doesn't change anything
    - name: Display upgradable packages
      ansible.builtin.debug:
        msg: "{{ apt_upgradable.stdout }}"
