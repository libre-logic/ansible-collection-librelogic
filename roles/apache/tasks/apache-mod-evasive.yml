---
##### APACHE MOD_EVASIVE #####

- name: Copy mod_evasive configuration
  ansible.builtin.template:
    src: etc_apache2_conf-available_mod-evasive.conf.j2
    dest: /etc/apache2/conf-available/mod-evasive.conf
    mode: "0644"
  when: apache_enable_mod_evasive|bool
  ignore_errors: "{{ ansible_check_mode }}"

- name: Enable apache mod_evasive
  ansible.builtin.command: a2enmod evasive
  args:
    creates: /etc/apache2/mods-enabled/evasive.load
  when: apache_enable_mod_evasive|bool
  notify: restart apache

- name: Enable apache mod_evasive configuration
  ansible.builtin.command: a2enconf mod-evasive
  args:
    creates: /etc/apache2/conf-enabled/mod-evasive.conf
  when: apache_enable_mod_evasive|bool
  notify: reload apache
  ignore_errors: "{{ ansible_check_mode }}"

- name: Disable apache mod_evasive
  ansible.builtin.command: a2dismod evasive
  args:
    removes: /etc/apache2/mods-enabled/evasive.load
  when: not apache_enable_mod_evasive|bool
  notify: restart apache

- name: Disable apache mod_evasive configuration
  ansible.builtin.command: a2disconf mod-evasive|bool
  args:
    removes: /etc/apache2/conf-enabled/mod-evasive.conf
  when: not apache_enable_mod_evasive|bool
  notify: reload apache
