##### LDAP Tool Box - Self-Service Password Reset

- name: install required packages for self-service-password
  apt:
    state: present
    package:
      - php-mbstring

- name: download self-service-password zip
  get_url:
    url: https://ltb-project.org/archives/ltb-project-self-service-password-1.3.tar.gz
    dest: /root/ltb-project-self-service-password-1.3.tar.gz

- name: extract self-service-password zip
  unarchive:
    src: /root/ltb-project-self-service-password-1.3.tar.gz
    dest: /root/
    copy: no
    owner: root
    group: root
    mode: u=rwX,g=rwX,o=rX

- name: move extracted archive to installation dir
  command: mv /root/ltb-project-self-service-password-1.3 /usr/share/self-service-password
  args:
    creates: /usr/share/self-service-password

- name: copy custom self-service-password assets/images
  copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    mode: 0644
  with_items:
    - { src: 'usr_share_self-service-password_images_background.png', dest: '/usr/share/self-service-password/images/background.png' }
    - { src: 'usr_share_self-service-password_images_libre-logic-logo.png', dest: '/usr/share/self-service-password/images/libre-logic-logo.png' }

- name: copy self-service-password configuration file
  template:
    src: usr_share_self-service-password_conf_config.inc.local.php.j2
    dest: /usr/share/self-service-password/conf/config.inc.local.php
    owner: root
    group: www-data
    mode: 0644

- name: copy self-service-password apache2 configuration
  copy:
    src: etc_apache2_conf-available_self-service-password.conf
    dest: /etc/apache2/conf-available/self-service-password.conf
    owner: root
    group: www-data
    mode: 0644
  notify: reload apache

- name: enable self-service-password apache configuration
  command: a2enconf self-service-password
  args:
    creates: /etc/apache2/conf-enabled/self-service-password.conf
  notify: reload apache

