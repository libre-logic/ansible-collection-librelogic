---
##### GET/SET FACTS #####

- name: Set variables for tar.bz2 installation method
  ansible.builtin.set_fact:
    ldap_account_manager_configcfg_dir: "{{ ldap_account_manager_install_dir }}/config"

- name: Check if ldap-account-manager installation directory exists
  ansible.builtin.stat:
    path: "{{ ldap_account_manager_install_dir }}"
  register: ldap_account_manager_dir

- name: Set the default installation action (do nothing)
  ansible.builtin.set_fact:
    ldap_account_manager_action: none

- name: Check if initial installation should be performed
  ansible.builtin.set_fact:
    ldap_account_manager_action: initial
  when:
    - ansible_local.ldap_account_manager.installed.version is undefined
    - not ldap_account_manager_dir.stat.exists

- name: Check if upgrade should be performed
  ansible.builtin.set_fact:
    ldap_account_manager_action: upgrade
  when:
    - ansible_local.ldap_account_manager.installed.version is defined
    - ansible_local.ldap_account_manager.installed.version < ldap_account_manager_version
    - ldap_account_manager_dir.stat.exists

##### CLEANUP #####

# remove lam installed from apt on debian 9
- name: Remove previous versions of ldap-account-manager
  ansible.builtin.apt:
    package: ldap-account-manager
    state: absent

##### DOWNLOAD/INSTALLATION #####

- name: Download ldap-account-manager tar.bz2
  ansible.builtin.get_url:
    url: https://netix.dl.sourceforge.net/project/lam/LAM/{{ ldap_account_manager_version }}/ldap-account-manager-{{ ldap_account_manager_version }}.tar.bz2
    dest: /root/ldap-account-manager-{{ ldap_account_manager_version }}.tar.bz2
    owner: root
    group: root
    mode: "0640"
  retries: 3
  when: ldap_account_manager_action == 'initial' or ldap_account_manager_action == 'upgrade'
  check_mode: false

- name: Create ldap-account-manager tar.bz2 extraction directory
  ansible.builtin.file:
    path: /root/ldap-account-manager-unpack
    state: directory
    mode: "0750"
  when: ldap_account_manager_action == 'initial' or ldap_account_manager_action == 'upgrade'
  check_mode: false

- name: Extract ldap-account-manager tar.bz2
  ansible.builtin.unarchive:
    src: "/root/ldap-account-manager-{{ ldap_account_manager_version }}.tar.bz2"
    dest: "/root/ldap-account-manager-unpack"
    remote_src: true
    owner: root
    group: www-data
    mode: u=rwX,g=rX
  when: ldap_account_manager_action == 'initial' or ldap_account_manager_action == 'upgrade'

- name: Give required write permissions to the webserver
  ansible.builtin.file:
    path: "{{ item }}"
    group: www-data
    mode: "g+wX"
    recurse: true
  with_items:
    - "/root/ldap-account-manager-unpack/ldap-account-manager-{{ ldap_account_manager_version }}/sess"
    - "/root/ldap-account-manager-unpack/ldap-account-manager-{{ ldap_account_manager_version }}/tmp"
    - "/root/ldap-account-manager-unpack/ldap-account-manager-{{ ldap_account_manager_version }}/tmp/internal"
    - "/root/ldap-account-manager-unpack/ldap-account-manager-{{ ldap_account_manager_version }}/config"
  when: ldap_account_manager_action == 'initial' or ldap_account_manager_action == 'upgrade'

- name: Delete old ldap-account-manager installation
  ansible.builtin.file:
    path: "{{ ldap_account_manager_install_dir }}"
    state: absent
  when: ldap_account_manager_action == 'upgrade'

- name: Move ldap_account_manager extraction directory to install directory # noqa no-changed-when
  ansible.builtin.command: mv /root/ldap-account-manager-unpack/ldap-account-manager-{{ ldap_account_manager_version }} '{{ ldap_account_manager_install_dir }}'
  when: ldap_account_manager_action == 'initial' or ldap_account_manager_action == 'upgrade'

##### ANSIBLE FACTS #####

- name: Create ansible facts.d directory
  ansible.builtin.file:
    path: /etc/ansible/facts.d
    state: directory
    mode: "0755"

- name: Create ldap-account-manager installed fact file
  ansible.builtin.template:
    src: etc_ansible_facts.d_ldap_account_manager.fact.j2
    dest: /etc/ansible/facts.d/ldap_account_manager.fact
    mode: "0644"

### CLEANUP ###

- name: Remove ldap-account-manager tar.bz2 extraction directory
  ansible.builtin.file:
    path: /root/ldap-account-manager-unpack
    state: absent
